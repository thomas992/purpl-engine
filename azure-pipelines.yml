trigger:
- main

strategy:
  matrix:
    windows-msvc-dist:
      imageName: 'windows-2022'
      config: 'MinSizeRel'
      cc: 'cl'
    windows-msvc-release:
      imageName: 'windows-2022'
      config: 'RelWithDebInfo'
      cc: 'cl'
    windows-msvc-debug:
      imageName: 'windows-2022'
      config: 'Debug'
      cc: 'cl'
    windows-clang-dist:
      imageName: 'windows-2022'
      config: 'MinSizeRel'
      cc: 'clang'
    windows-clang-release:
      imageName: 'windows-2022'
      config: 'RelWithDebInfo'
      cc: 'clang'
    windows-clang-debug:
      imageName: 'windows-2022'
      config: 'Debug'
      cc: 'clang'
    macos-dist:
      imageName: 'macos-latest'
      config: 'MinSizeRel'
      cc: 'clang'
    macos-release:
      imageName: 'macos-latest'
      config: 'RelWithDebInfo'
      cc: 'clang'
    macos-debug:
      imageName: 'macos-latest'
      config: 'Debug'
      cc: 'clang'
    linux-dist:
      imageName: 'ubuntu-latest'
      config: 'MinSizeRel'
      cc: 'clang'
    linux-release:
      imageName: 'ubuntu-latest'
      config: 'RelWithDebInfo'
      cc: 'clang'
    linux-debug:
      imageName: 'ubuntu-latest'
      config: 'Debug'
      cc: 'clang'

variables:
  artifactArchive: $(Build.ArtifactStagingDirectory)/purpl-$(imageName)-$(config)-$(cc).7z
  vulkanSdkVersion: 1.3.204
  vulkanSdk: C:\VulkanSDK\$(vulkanSdkVersion).1

pool:
  vmImage: $(imageName)

steps:
  - checkout: self
    submodules: true

  - script: |
      call tools\installvulkan.bat
    condition: eq(variables['Agent.OS'], 'Windows_NT')
    displayName: Install Vulkan SDK

  - bash: |
      chmod a+x tools/ninja
    condition: not(eq(variables['Agent.OS'], 'Windows_NT'))
    displayName: Set executable bit on Ninja

  - bash: |
      curl -fsGL https://packages.lunarg.com/lunarg-signing-key-pub.asc | sudo apt-key add -
      curl -fsGL https://packages.lunarg.com/vulkan/$(vulkanSdkVersion)/lunarg-vulkan-$(vulkanSdkVersion)-focal.list | sudo tee /etc/apt/sources.list.d/lunarg-vulkan-focal.list
      sudo apt update -qq
      sudo apt install -y vulkan-sdk libasound2-dev libdbus-1-dev libegl1-mesa-dev libgl1-mesa-dev libgles2-mesa-dev libglu1-mesa-dev libibus-1.0-dev libpulse-dev libsndio-dev libudev-dev libwayland-dev libx11-dev libxcursor-dev libxext-dev libxi-dev libxinerama-dev libxkbcommon-dev libxrandr-dev libxss-dev libxt-dev libxv-dev libxxf86vm-dev
    condition: eq(variables['Agent.OS'], 'Linux')
    displayName: Install Vulkan SDK and SDL dependencies with APT

  - script: |
      pip install MarkupSafe==2.1.0
      pip install Jinja2==3.0.3
    condition: eq(variables['Agent.OS'], 'Windows_NT')
    displayName: Install requirements for glad

  - script: |
      call tools\buildenv.bat
      cmake -S. -Bbuild -GNinja -DVULKAN_SDK=$(vulkanSdk) -DVulkan_LIBRARY=$(vulkanSdk)/Lib/vulkan-1.lib -DVulkan_INCLUDE_DIR=$(vulkanSdk)/Include -DCMAKE_C_COMPILER=$(cc) -DCMAKE_BUILD_TYPE=$(config)
    condition: eq(variables['Agent.OS'], 'Windows_NT')
    displayName: Generate build files (Windows)

  - script: |
      cmake -S. -Bbuild -GNinja -DVulkan_LIBRARY=/usr/lib/x86_64-linux-gnu/libvulkan.so -DCMAKE_C_COMPILER=$(cc) -DCMAKE_BUILD_TYPE=$(config)
    condition: eq(variables['Agent.OS'], 'Linux')
    displayName: Generate build files (Linux)

  - script: |
      cmake -S. -Bbuild -GXcode -DCMAKE_C_COMPILER=$(cc) -DCMAKE_BUILD_TYPE=$(config)
    condition: eq(variables['Agent.OS'], 'Darwin')
    displayName: Generate build files (macOS)

  - script: |
      call tools\buildenv.bat
      cmake --build build --config $(config)
      cmake --install build --config $(config)
    condition: eq(variables['Agent.OS'], 'Windows_NT')
    displayName: Build (Windows)

  - script: |
      cmake --build build --config $(config)
      cmake --install build --config $(config)
    condition: not(eq(variables['Agent.OS'], 'Windows_NT'))
    displayName: Build (non-Windows)

  - task: ArchiveFiles@2
    inputs:
      rootFolderOrFile: build/install
      archiveFile: $(artifactArchive)
      includeRootFolder: true
      archiveType: 7z
      replaceExistingArchive: true
      verbose: true

  - task: PublishBuildArtifacts@1
    inputs:
      pathToPublish: $(artifactArchive)
      artifactName: $(imageName)-$(config)-$(cc)

